<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

    <head>
        <title>Stutzen Example</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://unpkg.com/mathjs@12.2.0/lib/browser/math.js"></script>


        <style>
            :root,
            [data-bs-theme=dark] {
                --bs-blue: #ff6efd !important;
                --bs-primary: #ff6efd !important;
                --bs-body-color: white !important;
            }

            .btn-primary {
                --bs-btn-color: #fff;
                --bs-btn-bg: #ff6efd;
            }

            svg {
                background-color: white;
            }
        </style>
    </head>

    <body>
        <div class="container w-50">
            <center>
                <h3 class="mb-3 mt-3">Stutzen Example</h3>

                <svg id="svg" class="rounded-2" width="100%" height="400" viewBox="-25 -25 100 100" stroke="black"
                    stroke-width="1">

                    <defs>
                        <marker id="triangle" viewBox="0 0 10 10" refX="+10" refY="5" markerUnits="strokeWidth"
                            markerWidth="10" markerHeight="10" orient="auto">
                            <path d="M 0 0 L 10 5 L 0 10 z" fill="#f00" stroke="none" />
                        </marker>
                    </defs>

                    <line id="line1" x1="0" y1="0" x2="50" y2="0" />
                    <line id="line2" x1="0" y1="50" x2="0" y2="0" />
                    <circle id="circle1" cx="0" cx="0" r="2" fill="red" stroke="none" />

                </svg>
                <div id="output" class="mt-3 bg-white text-black w-100 p-2 border-1 border-dark rounded-2">sdfsdf</div>
            </center>
        </div>

        <script type="module">

            console.log(math.sqrt(-4).toString())

            const line1 = [
                [0, 0], [70, 50]
            ]

            const line2 = [
                [0, 50], [50, 0]
            ]



            function setLine(id, points) {
                let p1 = points[0]
                let p2 = points[1]
                const line = document.getElementById(id)
                line.setAttribute("x1", p1[0])
                line.setAttribute("x2", p2[0])
                line.setAttribute("y1", p1[1])
                line.setAttribute("y2", p2[1])
            }

            function setCircle(id, p, visible) {
                const circle = document.getElementById(id)
                circle.setAttribute("cx", p[0])
                circle.setAttribute("cy", p[1])
                circle.setAttribute("visibility", visible ? 'visible' : 'hidden')
            }

            function calc_m(line) {
                let p1 = line[0]
                let p2 = line[1]

                // y2-y1
                // -----
                // x2-x1

                let y2 = p2[1]
                let y1 = p1[1]
                let x2 = p2[0]
                let x1 = p1[0]

                let m = (y2 - y1) / (x2 - x1)

                return m

            }

            function calcIntersection(line1, line2) {

                // Punktsteigungsform
                // y - y_1 = m * (x - x_1)
                // y = m * (x - x_1) + y_1

                // Line 1 = Line 2
                // m1 * (x - x1) + y1 = m2 * (x - x2) + y2
                // m1*x - m1*x1 + y1 = m2*x - m2*x2 + y2
                // m1*x - m2*x = m1*x1 - y1 - m2*x2 + y2
                // x*(m1 - m2) = m1*x1 - y1 - m2*x2 + y2
                // x = (m1*x1 - y1 - m2*x2 + y2) / (m1 - m2)


                let m1 = calc_m(line1)
                let m2 = calc_m(line2)

                let x1 = line1[0][0]
                let x2 = line2[0][0]

                let y1 = line1[0][1]
                let y2 = line2[0][1]

                // If (m1 - m2) == 0 .. no intersection

                if ((m1 - m2) === 0) {
                    return [[0, 0], false]
                }

                let x = (m1 * x1 - y1 - m2 * x2 + y2) / (m1 - m2)

                // y = m1 * (x - x1) + y1

                let y = m1 * (x - x1) + y1

                return [[x, y], true]
            }

            function update() {

                setLine('line1', line1)
                setLine('line2', line2)

                let [p, found] = calcIntersection(line1, line2)

                function log(text) {
                    document.getElementById('output').innerText = text
                }

                if (found) {
                    log("intersection point:" + p[0] + "," + p[1])
                } else {
                    log("intersection point:" + "not exists")
                }

                setCircle("circle1", p, found)
            }

            update()

            function getCoords(event) {
                let svg = document.getElementById('svg')
                const CTM = svg.getScreenCTM()
                const point = {
                    x: (event.clientX - CTM.e) / CTM.a,
                    y: (event.clientY - CTM.f) / CTM.d
                }
                return point
            }

            document.getElementById('svg').addEventListener("pointermove", function (event) {
                let p = getCoords(event)
                line1[0][0] = p.x
                line1[0][1] = p.y
                update()
            })

        </script>
    </body>

</html>